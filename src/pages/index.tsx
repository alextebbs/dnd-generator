import { type NextPage } from "next";
import Head from "next/head";
import { md2jsx } from "~/utils/md2jsx";

import { useState } from "react";
import { type ICharacter } from "~/utils/Character";
import { CharacterSheet } from "~/components/CharacterSheet";

const Home: NextPage = () => {
  const [loadingState, setLoadingState] = useState("idle");
  const [character, setCharacter] = useState<ICharacter>({});

  const handleFormSubmit = async (e: React.SyntheticEvent<HTMLFormElement>) => {
    e.preventDefault();

    let url = "/api/generate/character";
    const form = e.target as HTMLFormElement;
    const elements = form.elements as typeof form.elements & {
      prompt: { value: string };
    };

    if (elements.prompt.value != "") {
      const params = { prompt: elements.prompt.value };
      url += "?" + new URLSearchParams(params).toString();
    }

    setLoadingState("loading");

    // QUESTION:
    // This throws some ESLint error @typescript-eslint/no-misused-promises and
    // checksVoidReturn ... I disabled the ESLint rule for now.
    const response = await fetch(url);
    const data = (await response.json()) as ICharacter;

    setLoadingState("done");

    setCharacter(data);
  };

  return (
    <>
      <Head>
        <title>Lore</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className="align-center flex h-[100vh] justify-center">
        <div className="">
          <form onSubmit={handleFormSubmit}>
            <div className="mt-4 flex justify-center">
              <div className="label">The character is</div>
              <input
                className="ml-1 mr-1 border-b bg-transparent focus:outline-none"
                name="prompt"
              />
              <div className="label">.</div>
            </div>
            <div className="mt-4 flex justify-center">
              <button className="rounded-md bg-red-600 p-2 px-4" type="submit">
                Generate
              </button>
            </div>
          </form>

          {loadingState == "idle" && (
            <div className="text-lg">
              Fill out the form and generate a character
            </div>
          )}

          {loadingState == "loading" && <div>Loading...</div>}

          {loadingState == "done" && <CharacterSheet character={character} />}
        </div>
      </main>
    </>
  );
};

export default Home;
